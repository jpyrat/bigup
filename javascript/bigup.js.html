#HTTP_HEADER{Content-Type: text/javascript}
[(#REM)<script>]

(function($){
$(document).ready(function(){
	var formulaires_avec_bigup = function() {
		// trouver les input qui envoient des fichiers
		$(".formulaire_spip form input[type=file].bigup").bigup();
	}
	formulaires_avec_bigup();
	onAjaxLoad(formulaires_avec_bigup);

});


/**
 * Pour un input de type file sélectionné,
 * gère l'upload de ou des fichiers, via html5 et flow.js
 */
$.fn.bigup = function() {
	$(this).each(function() {
		// trouver les paramètres ciblant le formulaire
		var name     = $(this).attr('name');
		var token    = $(this).data('token');
		var multiple = $(this).prop('multiple');
		var accept   = $(this).prop('accept');

		var $form = $(this).parents('form');
		var target = $form.attr('action');
		var formulaire_action = $form.find('input[name=formulaire_action]').val();
		var formulaire_action_args = $form.find('input[name=formulaire_action_args]').val();

		// La librairie d'upload
		var flow = new Flow({
			input: $(this),
			target: target,
			fileParameterName: name,
			testChunks: true,
			maxFiles: (multiple ? 0 : 1), // TODO: gérer un nombre de fichiers maxi
			query: {
				bigup_token: token,
				formulaire_action: formulaire_action,
				formulaire_action_args: formulaire_action_args,
				accept: accept // accept pourra servir au serveur pour éviter un stockage inutile
			}
		});

		// Si l'upload html5 n'est pas supporté,
		// on laisse la gestion au formulaire… comme au bon vieux temps
		if (!flow.support) {
			return false;
		}

		// Trouver une zone où déposer les fichiers dans le HTML existant
		var $zone = $form.find(".dropfile_" + name);

		// S'il n'y en a pas, créer le template par défaut et l'ajouter
		if (!$zone.length) {
			var template = $.bigup_template(name, multiple);
			$(this).after(template);
			$zone = $form.find(".dropfile_" + name);
		}

		// Voir la zone, cacher l'input original
		$(this).hide();
		$zone.show();

		// Assigner la zone et son bouton à flow.
		flow.assignBrowse($zone.find('.dropfilebutton'), false, !multiple, {accept: accept});
		flow.assignDrop($zone);

		// Valider chaque fichier déposé en fonction du 'accept' de l'input.
		flow.on('fileAdded', function(file,  event){
			if (typeof file.flowObj.opts.query.accept !== undefined) {
				var accept = file.flowObj.opts.query.accept;
				if (accept && !$.bigup_isValidFile(file.file, accept)) {
					// TODO: afficher une vraie erreur
					console.log("Fichier non accepté !");
					return false;
				}
			}
		});

		// Téléverser aussitôt les fichiers valides déposés
		flow.on('filesSubmitted', function (files) {
			console.log('filesSubmitted', files);
			if (files.length) {
				for (var i = 0; i < files.length; i++) {
					var file = files[i];

					var $input = file.flowObj.opts.input;
					var name = file.flowObj.opts.fileParameterName;

					// Trouver une zone où afficher les fichiers dans le HTML existant
					var $zone = $input.parents('form').find(".fichiers_" + name);

					// S'il n'y en a pas, créer le template par défaut et l'ajouter
					if (!$zone.length) {
						var template = "<div class='bigup_fichiers fichiers_" + name + "'></div>";
						$input.before(template);
						$zone = $form.find(".fichiers_" + name);
					}

					// Ajouter le fichier à la zone
					var template = $.bigup_template_fichier(file.file);
					$zone.append(template);
					// Conserver en mémoire l'emplacement
					// Inversement, depuis l'emplacement, pouvoir retrouver le fichier
					file.zone = $zone.find(".fichier:last-child").animateAppend().data('file', file);
				}
				flow.upload();
			}
		});

		flow.on('fileProgress', function(file, chunk){
			var percent = Math.round(file._prevUploadedSize / file.size * 100);
			file.zone.find('progress').text( percent + " %" ).animer_progress(percent);
		});

		flow.on('fileSuccess', function(file, message, chunk){
			console.info("success", file, message, chunk);
			file.zone.find(".cancel").fadeOut("normal", function(){ $(this).remove(); });
			// Attendre qu'on soit forcément à 100% sur le progress et l'enlever en douceur
			file.zone.find("progress").delay(1000).fadeOut("normal", function(){
				 $(this).slideUp("normal", function(){ $(this).remove(); });
			});
		});

		flow.on('fileError', function(file, message, chunk){
			console.warn("error", file, message, chunk);
		});

		return true;
	});
}

/**
 * Vérifier un fichier par rapport à un attribut 'accept'
 * Code issu de Dropzone.
 */
$.bigup_isValidFile = function(file, acceptedFiles) {
	var baseMimeType, mimeType, validType, _i, _len;
	if (!acceptedFiles) {
		return true;
	}
	acceptedFiles = acceptedFiles.split(",");
	mimeType = file.type;
	baseMimeType = mimeType.replace(/\/.*$/, "");
	for (_i = 0, _len = acceptedFiles.length; _i < _len; _i++) {
		validType = acceptedFiles[_i];
		validType = validType.trim();
		if (validType.charAt(0) === ".") {
			if (file.name.toLowerCase().indexOf(validType.toLowerCase(), file.name.length - validType.length) !== -1) {
				return true;
			}
		} else if (/\/\*$/.test(validType)) {
			if (baseMimeType === validType.replace(/\/.*$/, "")) {
				return true;
			}
		} else {
			if (mimeType === validType) {
				return true;
			}
		}
	}
	return false;
};


/**
 * Annuler le transfert d'un fichier déposé qui se téléverse
 */
$.bigup_annuler_transfert = function(me) {
	var $fichier = $(me).parents('.fichier');
	var file = $fichier.data('file');
	file.cancel();
	$fichier.animateRemove(function(){
		$(this).remove();
	});
}

/**
 * Augmente une balise progress à la valeur indiquée. Mais doucement
 */
$.fn.animer_progress = function(val) {
	$(this).each(function() {
		var me = this;
		$({
			// The value at present
			interpVal: me.value
		}).animate({
			interpVal: val
		}, {
			// How long this interpolation should take
			duration: 1000,
			// The function to set the progress bar's value to the inter val
			step: function () {
				me.value = this.interpVal;
			}
		});
	});
	return this;
}


/**
 * Crée un template HTML de la zone de dépot de fichier pour un nom de champ donné.
 */
$.bigup_template = function(name, multiple) {

	var template =  
		'\n<div class="dropfile dropfile_' + name + '" style="display:none;">'
		+ '\n\t<span class="dropfilebutton bigup-btn btn btn-default"><:bigup:televerser|texte_script:></span>'
		+ '\n\t<span class="dropfileor"><:bigup:ou|texte_script:></span>'
		+ '\n\t<span class="dropfiletext">'
		+ '\n\t\t' + (multiple ? '<:bigup:deposer_vos_fichiers_ici|texte_script:>' : '<:bigup:deposer_votre_fichier_ici|texte_script:>' )
		+ '\n\t</:span:>'
		+ '\n</div>\n';

	return template;
};

/**
 * Crée un template HTML de la vue d'un fichier
 */
$.bigup_template_fichier = function(file) {

	// retouver l'extension
	var extension = $.trouver_extension(file.name);
	var t_annuler = "<:bouton_annuler|texte_script:>";

	var template =
		'\n<div class="fichier">'
		+ '\n\t<div class="actions">'
		+ '\n\t\t<span class="bigup-btn btn btn-default cancel" onClick="$.bigup_annuler_transfert(this); return false;">' + t_annuler + '</span>'
		+ '\n\t</div>'
		+ '\n\t<div class="infos vignette_extension ' + extension + '">'
		+ '\n\t\t<span class="name"><strong>' + file.name + '</strong></span>'
		+ '\n\t\t<span class="size">' + $.taille_en_octets(file.size) + '</span>'
		+ '\n\t\t<span class="mime">' + file.type + '</span>'
		+ '\n\t</div>'
		+ '\n\t\t<progress value="0" max="100">0 %</progress>'
		+ '\n</div>\n';

	return template;
};


/**
 * Retrouve (et corrige) une extension dans un nom de fichier
 */
$.trouver_extension = function(name) {
	// retouver l'extension
	var re = /(?:\.([^.]+))?$/;
	var extension = re.exec(name)[1];
	extension = extension.toLowerCase();

	// cf corriger_extension() dans plugin medias.
	switch (extension) {
		case 'htm':
			extension='html';
			break;
		case 'jpeg':
			extension='jpg';
			break;
		case 'tiff':
			extension='tif';
			break;
		case 'aif':
			extension='aiff';
			break;
		case 'mpeg':
			extension='mpg';
			break;
	}
	return extension;
}


/**
 * Calcule une taille en octets humainement lisible
 * @param int taille Taille en octets
 * @return string 
 */
$.taille_en_octets = function(taille) {
	var ko = 1024;
	var t_octets = "<:taille_octets|texte_script:>";
	var t_ko     = "<:taille_ko|texte_script:>";
	var t_mo     = "<:taille_mo|texte_script:>";
	var t_go     = "<:taille_go|texte_script:>";
	if (taille < ko) {
		return t_octets.replace('@taille@', taille);
	} else if (taille < ko * ko) {
		return t_ko.replace('@taille@', Math.round(taille/ko * 10) / 10);
	} else if (taille < ko * ko * ko) {
		return t_mo.replace('@taille@', Math.round(taille/ko/ko * 10) / 10);
	} else {
		return t_go.replace('@taille@', Math.round(taille/ko/ko/ko * 10) / 10);
	}
}

})(jQuery);
