#HTTP_HEADER{Content-Type: text/javascript}
[(#REM)<script>]

(function($){
$(document).ready(function(){
	var formulaires_avec_bigup = function() {
		// trouver les input qui envoient des fichiers
		$(".formulaire_spip form input[type=file].bigup").bigup();
	}
	formulaires_avec_bigup();
	onAjaxLoad(formulaires_avec_bigup);

});


/**
 * Pour un input de type file sélectionné,
 * gère l'upload du ou des fichiers, via html5 et flow.js
 */
$.fn.bigup = function() {
	$(this).not(".bigup_done").each(function() {
		// indiquer que l'input est traité. Évite de charger plusieurs fois Flow
		$(this).addClass('bigup_done');

		// trouver les paramètres ciblant le formulaire
		var name     = $(this).attr('name').replace(/\\[\\]$/, ""); // Note : \[\] est déjà un échappement SPIP !
		var token    = $(this).data('token');
		var multiple = $(this).prop('multiple');
		var accept   = $(this).prop('accept');

		var $form = $(this).parents('form');
		var target = $form.attr('action');
		var formulaire_action = $form.find('input[name=formulaire_action]').val();
		var formulaire_action_args = $form.find('input[name=formulaire_action_args]').val();

		// La librairie d'upload
		var flow = new Flow({
			input: $(this),
			target: target,
			fileParameterName: name,
			testChunks: true,
			maxFiles: (multiple ? 0 : 1), // TODO: gérer un nombre de fichiers maxi
			singleFile: !multiple,
			simultaneousUploads: 2, // 3 par défaut
			permanentErrors : [403, 404, 413, 415, 500, 501], // ajout de 403 à la liste par défaut.
			query: {
				action: "bigup",
				bigup_token: token,
				formulaire_action: formulaire_action,
				formulaire_action_args: formulaire_action_args,
				accept: accept // accept pourra servir au serveur pour éviter un stockage inutile
			}
		});

		// Si l'upload html5 n'est pas supporté,
		// on laisse la gestion au formulaire… comme au bon vieux temps
		if (!flow.support) {
			return false;
		}

		// flow facilement accessible depuis l'input.
		$(this).data('flow', flow);

		// S'il y a déjà des fichiers en attente, remplacer leurs boutons "Enlever"
		// par un équivalent en JS, ce qui évite de tout recharger le formulaire pour ça.
		$form.bigup_remplacer_boutons_enlever(name);

		// Trouver une zone où déposer les fichiers dans le HTML existant
		var $zone_depot = $form.find(".dropfile_" + name);

		// S'il n'y en a pas, créer le template par défaut et l'ajouter
		if (!$zone_depot.length) {
			var template = $.bigup_template_zone_depot(name, multiple);
			$(this).after(template);
			$zone_depot = $form.find(".dropfile_" + name);
		}

		// stocker des infos utilse dans flow.
		flow.$form = $form;
		flow.$zone_depot = $zone_depot;


		// Cacher l'input original
		$(this).hide();

		// Voir la zone, si on n'a pas déjà atteint le quota de fichiers
        $.bigup_adapter_visibilite_zone_depot(flow);

		// Assigner la zone et son bouton à flow.
		flow.assignBrowse($zone_depot.find('.dropfilebutton'), false, !multiple, {accept: accept});
		flow.assignDrop($zone_depot);

		// Présenter le fichier dans liste des fichiers en cours
		// Valider le fichier déposé en fonction du 'accept' de l'input (si présent).
		flow.on('fileAdded', function(file,  event) {
			$.bigup_ajouter_fichier(file);
			$.bigup_adapter_visibilite_zone_depot(file.flowObj);
			if (!$.bigup_accepter_fichier(file)) {
				$.bigup_presenter_erreur(file, "Type de fichier incorrect !");
				return false;
			}
		});

		// Téléverser aussitôt les fichiers valides déposés
		flow.on('filesSubmitted', function (files) {
			if (files.length) {
				$.each(files, function(key, file) {
					file.zone.ajouter_progress();
				});
				flow.upload();
			}
		});

		// Actualiser la barre de progression de l'upload
		flow.on('fileProgress', function(file, chunk){
			var percent = Math.round(file._prevUploadedSize / file.size * 100);
			file.zone.find('progress').text( percent + " %" ).animer_progress(percent);
		});

		// Réussite de l'opload :
		// Adapter le bouton 'Annuler' => 'Enlever'
		// Retirer la barre de progression
		flow.on('fileSuccess', function(file, message, chunk){
			console.info("success", file, message, chunk);
			var desc = $.parseJSON(message);
			// enlever le bouton annuler
			file.zone.find(".cancel").fadeOut("normal", function(){
				$(this).remove();
				// et mettre un bouton enlever !
				if (desc.identifiant) {
					var name = file.flowObj.opts.fileParameterName;
					file.zone.bigup_ajouter_bouton_enlever(name, desc.identifiant);
				}
			});
			file.zone.find("progress").retirer_progress();
		});

		// Erreur, pas de bol !
		// Afficher l'erreur
		// Retirer la barre de progression
		flow.on('fileError', function(file, message, chunk){
			console.warn("error", file, message, chunk);
			file.zone.find("progress").retirer_progress();
			$.bigup_presenter_erreur(file, "Erreur de transfert !");
		});

		return true;
	});
}

/**
 * Affiche ou cache la zone de dépot en fonction du nombre de fichiers déjà actifs
 *
 * @param object flow L'objet flow.js
 */
$.bigup_adapter_visibilite_zone_depot = function(flow) {
    var nb = flow.$form.find(".fichiers_" + flow.opts.fileParameterName + " .fichier").length;
	if (!flow.opts.maxFiles || (flow.opts.maxFiles > nb)) {
		flow.$zone_depot.show();
	} else {
		flow.$zone_depot.hide();
	}
}

/**
 * Remplacer les boutons "Enlever" d'origine sur les fichiers déjà présents
 * dans le formulaire (listés au dessus du champ).
 *
 * On remplace par un équivalent qui fera la chose en pur JS + ajax
 * @param string name
 *     Nom du champ (name) concerné.
 */
$.fn.bigup_remplacer_boutons_enlever = function(name) {
	var t_enlever = "<:bigup:bouton_enlever|texte_script:>";

	// Trouver les fichiers s'il y en a
	var $fichiers = $(this).find(".fichiers_" + name + " .fichier");
	$fichiers.each(function(){
		var $button = $(this).find("button[name=bigup_enlever_fichier]");
		var identifiant = $button.val();
		$button.remove();
		$(this).bigup_ajouter_bouton_enlever(name, identifiant);
	});

	return this;
}

/**
 * Ajoute un "Enlever" sur un fichier 
 *
 * @param string name Nom du champ (name) concerné.
 * @param string identifiant Identifiant (md5 du chemin sur le serveur) du fichier concerné
 */
$.fn.bigup_ajouter_bouton_enlever = function(name, identifiant) {
	var t_enlever = "<:bigup:bouton_enlever|texte_script:>";

	var js = "$.bigup_enlever_fichier(this, '" + name + "', '" + identifiant + "'); return true;";
	var inserer = '<span class="bigup-btn btn btn-default" onClick="' + js + '">' + t_enlever + '</span>';

	$(this).find('.actions').append(inserer);

	return this;
}




/**
 * Ajoute le fichier transmis dans la liste des fichiers au dessus
 * de la zone de dépot
 */
$.bigup_ajouter_fichier = function(file) {
	var $input = file.flowObj.opts.input;
	var name = file.flowObj.opts.fileParameterName;

	// Trouver une zone où afficher les fichiers dans le HTML existant
	var $zone = $input.parents('form').find(".fichiers_" + name);

	// S'il n'y en a pas, créer le template par défaut et l'ajouter
	if (!$zone.length) {
		var template = "<div class='bigup_fichiers fichiers_" + name + "'></div>";
		$input.before(template);
		$zone = $input.parents('form').find(".fichiers_" + name);
	}

	// Ajouter le fichier à la zone
	var template = $.bigup_template_fichier(file.file);
	$zone.append(template);

	// Conserver en mémoire l'emplacement dans file
	// Inversement, depuis l'emplacement, pouvoir retrouver le fichier
	file.zone = $zone.find(".fichier:last-child").animateAppend().data('file', file);

	return true;
}

/**
 * Tester que le fichier est valide par rapport à l'attribut `accept` de l'input.
 * @return true si OK.
 */
$.bigup_accepter_fichier = function(file) {
	if (typeof file.flowObj.opts.query.accept !== undefined) {
		var accept = file.flowObj.opts.query.accept;
		if (accept && !$.bigup_isValidFile(file.file, accept)) {
			return false;
		}
	}
	return true;
}


/**
 * Vérifier un fichier par rapport à un attribut 'accept'
 * Code issu de Dropzone.
 */
$.bigup_isValidFile = function(file, acceptedFiles) {
	var baseMimeType, mimeType, validType, _i, _len;
	if (!acceptedFiles) {
		return true;
	}
	acceptedFiles = acceptedFiles.split(",");
	mimeType = file.type;
	baseMimeType = mimeType.replace(/\/.*$/, "");
	for (_i = 0, _len = acceptedFiles.length; _i < _len; _i++) {
		validType = acceptedFiles[_i];
		validType = validType.trim();
		if (validType.charAt(0) === ".") {
			if (file.name.toLowerCase().indexOf(validType.toLowerCase(), file.name.length - validType.length) !== -1) {
				return true;
			}
		} else if (/\/\*$/.test(validType)) {
			if (baseMimeType === validType.replace(/\/.*$/, "")) {
				return true;
			}
		} else {
			if (mimeType === validType) {
				return true;
			}
		}
	}
	return false;
};

/**
 * Une erreur est apparue sur un fichier à téléverser.
 * L'indiquer
 */
$.bigup_presenter_erreur = function(file, message) {
	var $zone = file.zone;
	$zone.bigup_presenter_erreur(message);
	return true;
}

/**
 * Ajoute une erreur sur la description d'un fichier
 */
$.fn.bigup_presenter_erreur = function(message) {
	$(this).addClass('erreur').find('.infos').append("<span class='message_erreur'>" + message + "</span>");
	return this;
}

/**
 * Annuler le transfert d'un fichier déposé qui se téléverse
 * @param object me
 *   L'élément qui a cliqué
 */
$.bigup_annuler_transfert = function(me) {
	var file = $(me).parents('.fichier').data('file');
	file.cancel();
	$.bigup_enlever_fichier(me, file.flowObj.opts.fileParameterName, file.uniqueIdentifier);
}

/**
 * Enlève le fichier du serveur et sur la liste des fichiers déjà téléversés
 * @param object me
 *     L'élément qui a cliqué
 * @param string name
 *     Le name de l'input file
 * @param string identifiant
 *     L'identifiant du fichier sur le serveur
 */
$.bigup_enlever_fichier = function(me, name, identifiant) {
	var $fichier = $(me).parents('.fichier');
	var $form = $fichier.parents('form');
	var $input = $form.find('input.bigup[name=' + name + ']');
	if (!$input.length) {
		var $input = $form.find('input.bigup[name="' + name + '[]"]');
	}

	// trouver les paramètres ciblant le formulaire
	var token = $input.data('token');
	var target = $form.attr('action');
	var formulaire_action = $form.find('input[name=formulaire_action]').val();
	var formulaire_action_args = $form.find('input[name=formulaire_action_args]').val();

	$.post(target, {
		action: "bigup",
		formulaire_action: formulaire_action,
		formulaire_action_args: formulaire_action_args,
		bigup_token: token,
		bigup_action: 'effacer',
		identifiant: identifiant,
	})
	.done(function() {
		$fichier.animateRemove(function(){
			$(this).remove();
			$.bigup_adapter_visibilite_zone_depot($input.data('flow'));
		});
	})
	.fail(function() {
		$fichier.bigup_presenter_erreur("Un problème est survenu…");
	});
}



/**
 * Ajoute une balise progress dans le contenu, en douceur
 */
$.fn.ajouter_progress = function() {
	var progress = $('<progress value="0" max="100" style="display:none">0 %</progress>');
	$(this).append(progress);
	progress.fadeIn(1000); /* marche pas terrible */
	return this;
}

/**
 * Augmente une balise progress à la valeur indiquée. Mais doucement
 */
$.fn.animer_progress = function(val) {
	$(this).each(function() {
		var me = this;
		$({percent: me.value}).animate({percent: val}, {
			duration: 1000,
			step: function () { me.value = this.percent; }
		});
	});
	return this;
}


/**
 * Retire une balise progress du html, en douceur
 */
$.fn.retirer_progress = function(val) {
	// meme durée que sur animer_progress() pour attendre la fin
	$(this).delay(1000).fadeOut("normal", function(){
		$(this).slideUp("normal", function(){ $(this).remove(); });
	});
	return this;
}

/**
 * Crée un template HTML de la zone de dépot de fichier pour un nom de champ donné.
 */
$.bigup_template_zone_depot = function(name, multiple) {

	var template =  
		'\n<div class="dropfile dropfile_' + name + '" style="display:none;">'
		+ '\n\t<span class="dropfilebutton bigup-btn btn btn-default"><:bigup:televerser|texte_script:></span>'
		+ '\n\t<span class="dropfileor"><:bigup:ou|texte_script:></span>'
		+ '\n\t<span class="dropfiletext">'
		+ '\n\t\t' + (multiple ? '<:bigup:deposer_vos_fichiers_ici|texte_script:>' : '<:bigup:deposer_votre_fichier_ici|texte_script:>' )
		+ '\n\t</:span:>'
		+ '\n</div>\n';

	return template;
};

/**
 * Crée un template HTML de la vue d'un fichier
 */
$.bigup_template_fichier = function(file) {

	// retouver l'extension
	var extension = $.trouver_extension(file.name);
	var t_annuler = "<:bouton_annuler|texte_script:>";

	var template =
		'\n<div class="fichier">'
		+ '\n\t<div class="actions">'
		+ '\n\t\t<span class="bigup-btn btn btn-default cancel" onClick="$.bigup_annuler_transfert(this); return false;">' + t_annuler + '</span>'
		+ '\n\t</div>'
		+ '\n\t<div class="description">'
		+ '\n\t\t<div class="vignette_extension ' + extension + '" title="' + file.type + '"></div>'
		+ '\n\t\t<div class="infos">'
		+ '\n\t\t\t<span class="name"><strong>' + file.name + '</strong></span>'
		+ '\n\t\t\t<span class="size">' + $.taille_en_octets(file.size) + '</span>'
		+ '\n\t\t</div>'
		+ '\n\t</div>'
		+ '\n</div>\n';

	return template;
};


/**
 * Retrouve (et corrige) une extension dans un nom de fichier
 */
$.trouver_extension = function(name) {
	// retouver l'extension
	var re = /(?:\.([^.]+))?$/;
	var extension = re.exec(name)[1];
	extension = extension.toLowerCase();

	// cf corriger_extension() dans plugin medias.
	switch (extension) {
		case 'htm':
			extension='html';
			break;
		case 'jpeg':
			extension='jpg';
			break;
		case 'tiff':
			extension='tif';
			break;
		case 'aif':
			extension='aiff';
			break;
		case 'mpeg':
			extension='mpg';
			break;
	}
	return extension;
}


/**
 * Calcule une taille en octets humainement lisible
 * @param int taille Taille en octets
 * @return string 
 */
$.taille_en_octets = function(taille) {
	var ko = 1024;
	var t_octets = "<:taille_octets|texte_script:>";
	var t_ko     = "<:taille_ko|texte_script:>";
	var t_mo     = "<:taille_mo|texte_script:>";
	var t_go     = "<:taille_go|texte_script:>";
	if (taille < ko) {
		return t_octets.replace('@taille@', taille);
	} else if (taille < ko * ko) {
		return t_ko.replace('@taille@', Math.round(taille/ko * 10) / 10);
	} else if (taille < ko * ko * ko) {
		return t_mo.replace('@taille@', Math.round(taille/ko/ko * 10) / 10);
	} else {
		return t_go.replace('@taille@', Math.round(taille/ko/ko/ko * 10) / 10);
	}
}

})(jQuery);
